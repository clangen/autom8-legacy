#!/bin/bash

# before you can stage you must have all build dependencies installed:
#  - sudo npm install -g closurecompiler
#  - npm install clean-css closurecompiler colors ffi prompt ref socket.io-client commander express lodash q socket.io stripcolorcodes jsonminify less
#  - apt-get install build-essential clang-3.4 make libsqlite3-dev libssl-dev libboost1.54-all-dev

VERSION=0.7.3
#NODE_TARBALL=node-v0.10.24-linux-arm-armv6j-vfp-hard
#NODE_TARBALL=node-v0.10.26-linux-x86
NODE_TARBALL=node-v0.10.26-darwin-x64

echo "[*] deleting current staging area, if exists"
rm -rf build/stage/

echo "[*] replacing version in autom8.cpp with $VERSION"
pushd libautom8/src/ > /dev/null
perl -p -i -e "s/#define VERSION \".*\"/#define VERSION \"$VERSION\"/g" autom8.cpp
popd > /dev/null

echo "[*] building libautom8"
make

echo "[*] copying server files and libautom8 to staging area"
mkdir -p build/stage/bin
mkdir -p build/stage/lib/autom8
mkdir -p build/stage/share

# get the important files in place
cp -rfp autom8_node/client build/stage/lib/autom8
cp -rfp autom8_node/server build/stage/lib/autom8
cp -rfp autom8_node/shared build/stage/lib/autom8
cp bin/init.rc build/stage/bin/autom8-init.rc
cp bin/autom8 build/stage/bin/autom8
mv build/stage/lib/autom8/shared/conf/ build/stage/share/autom8
cp libautom8.so build/stage/lib/ 2> /dev/null
cp libautom8.dylib build/stage/lib/ 2> /dev/null

# we'll build these fresh
# rm build/stage/lib/autom8/client/minifier.cache
# rm build/stage/lib/autom8/server/minifier.cache

echo "[*] compiling server"
pushd ./build/stage/lib/autom8/server > /dev/null
node compile.js
popd > /dev/null

echo "[*] compiling client"
pushd ./build/stage/lib/autom8/client > /dev/null
node compile.js
popd > /dev/null

echo "[*] removing files that don't need to be distributed"
rm -rf build/stage/lib/autom8/client/frontend/js
rm -rf build/stage/lib/autom8/client/frontend/css
rm -rf build/stage/lib/autom8/client/frontend/templates/*.scripts
rm -rf build/stage/lib/autom8/client/frontend/templates/*.styles
rm -rf build/stage/lib/autom8/server/frontend/js
rm -rf build/stage/lib/autom8/server/frontend/css
rm -rf build/stage/lib/autom8/server/frontend/templates/*.scripts
rm -rf build/stage/lib/autom8/server/frontend/templates/*.styles
rm -rf build/stage/lib/autom8/shared/css
rm build/stage/lib/autom8/shared/templates/*.scripts
rm build/stage/lib/autom8/shared/templates/*.styles
rm -rf build/stage/lib/autom8/shared/js/3rdparty
rm -rf build/stage/lib/autom8/shared/js/frontend
rm ./build/stage/lib/autom8/server/compile.js
rm ./build/stage/lib/autom8/server/backend/raw.js
rm ./build/stage/lib/autom8/client/compile.js

echo "[*] compressing server-side js..."
# for js in $(find ./build/stage -name *.js)
# do
#     echo "  $js"
#     ccjs $js > $js.min
#     mv $js.min $js
# done

# auto-stage to `pwd`
# echo "[*] auto-staging to current directory"
# pushd build/stage > /dev/null
# PREFIX=$(echo $PWD | sed 's_/_\\/_g') # cwd, with escaped slashes
# echo "[*] replacing {{PREFIX}} with $PWD"
# find . -type f -print0 | xargs -0 perl -p -i -e "s/{{PREFIX}}/$PREFIX/g"
# popd > /dev/null

echo "[*] setting client versions to $VERSION"
pushd build/stage > /dev/null
find . -type f -print0 | xargs -0 perl -p -i -e "s/{{version}}/$VERSION/g"
popd > /dev/null

echo "[*] creating local node installation"
cp ./bin/$NODE_TARBALL.tar.gz ./build/stage/lib/autom8
pushd ./build/stage/lib/autom8 > /dev/null
tar xvfz $NODE_TARBALL.tar.gz
mv $NODE_TARBALL node
rm $NODE_TARBALL.tar.gz
popd > /dev/null

echo "[*] copying installation script, readme, and license"
cp bin/install build/
cp LICENSE build/
cp LICENSE.3rdparty build/
cp LICENSE.nodejs build/
cp LICENSE build/stage/share/autom8
cp LICENSE.3rdparty build/stage/share/autom8
cp LICENSE.nodejs build/stage/share/autom8

echo "[*] done"